# structure and content of CMakeLists.txt files adapted from 
# https://stackoverflow.com/questions/55635294/how-to-create-packages-with-cmake

cmake_minimum_required(VERSION 3.9.0)
project(parallelproj LANGUAGES C VERSION 0.6)

include(CMakePackageConfigHelpers)
include(CheckLanguage)

# get standard paths for installation
include(GNUInstallDirs)

set (CMAKE_BUILD_TYPE Release CACHE STRING "build type" FORCE)

#-------------------------------------------------------------

# define INSTALL dirs for libraries, public headers and documentation
# by default we use the GNUInstallDirs

set(PARALLELPROJ_INSTALL_LIBDIR ${CMAKE_INSTALL_LIBDIR} CACHE PATH "install subdir for libs")
set(PARALLELPROJ_INSTALL_INCLUDEDIR ${CMAKE_INSTALL_INCLUDEDIR} CACHE PATH "install subdir for public headers")
set(PARALLELPROJ_INSTALL_DOCDIR ${CMAKE_INSTALL_DOCDIR} CACHE PATH "install subdir for documentation")

# user variable whether to install the doxygen docs as well
set(PARALLELPROJ_INSTALL_DOCS TRUE CACHE BOOL "install the docs generated by doxygen" )

# variable whether to build with auto-generated IDL wrappers
set(PARALLELPROJ_BUILD_WITH_IDL_WRAPPERS FALSE CACHE BOOL "include auto-generate IDL wrapper sources in build")

#-------------------------------------------------------------
# checks for OpenMP, CUDA and doxygen

# find the required OpeMP
find_package(OpenMP REQUIRED)

# check if CUDA is available
check_language(CUDA)

# check if Doxygen is installed
find_package(Doxygen)


#-------------------------------------------------------------
# build the C/OpenMP lib
add_subdirectory(c)


# only build CUDA lib if CUDA is available
if(CMAKE_CUDA_COMPILER)
  add_subdirectory(cuda)
endif()

#-------------------------------------------------------------
# install the targets
install(
  EXPORT parallelprojTargets
  DESTINATION ${PARALLELPROJ_INSTALL_LIBDIR}/cmake/parallelproj
  NAMESPACE parallelproj::
  FILE parallelprojTargets.cmake # Not sure if this is still needed
  )


#-------------------------------------------------------------
# build the documentation with Doxygen

if (DOXYGEN_FOUND)
  # set input and output files
  set(DOXYGEN_IN ${CMAKE_CURRENT_SOURCE_DIR}/cmake/Doxyfile.in)
  set(DOXYGEN_OUT ${CMAKE_CURRENT_BINARY_DIR}/Doxyfile)

  # request to configure the file
  configure_file(${DOXYGEN_IN} ${DOXYGEN_OUT} @ONLY)

  # note the option ALL which allows to build the docs together with the application
  add_custom_target( doc_doxygen ALL
      COMMAND ${DOXYGEN_EXECUTABLE} ${DOXYGEN_OUT}
      WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
      COMMENT "Generating API documentation with Doxygen"
      VERBATIM )

  if (PARALLELPROJ_INSTALL_DOCS)
    install( DIRECTORY docs/html
      DESTINATION ${PARALLELPROJ_INSTALL_DOCDIR}
      FILES_MATCHING
      PATTERN "*")
  endif (PARALLELPROJ_INSTALL_DOCS)

endif (DOXYGEN_FOUND)


#-------------------------------------------------------------
# generate and install cmake package and version files
if(CMAKE_CUDA_COMPILER)
  set(CUDA_SUPPORTED ON)
endif()
  
configure_package_config_file(
  ${CMAKE_CURRENT_SOURCE_DIR}/cmake/Config.cmake.in
  ${CMAKE_CURRENT_BINARY_DIR}/parallelprojConfig.cmake
  INSTALL_DESTINATION ${PARALLELPROJ_INSTALL_LIBDIR}/cmake/parallelproj
  PATH_VARS
    PARALLELPROJ_INSTALL_LIBDIR
  )

write_basic_package_version_file(
  ${CMAKE_CURRENT_BINARY_DIR}/parallelprojConfigVersion.cmake
  VERSION ${parallelproj_VERSION}
  COMPATIBILITY SameMajorVersion
  )

# Install Config and ConfigVersion files
install(
  FILES "${CMAKE_CURRENT_BINARY_DIR}/parallelprojConfig.cmake"
        "${CMAKE_CURRENT_BINARY_DIR}/parallelprojConfigVersion.cmake"
  DESTINATION "${PARALLELPROJ_INSTALL_LIBDIR}/cmake/parallelproj"
  )

# uninstall target
if(NOT TARGET uninstall)
    configure_file(
        "${CMAKE_CURRENT_SOURCE_DIR}/cmake/cmake_uninstall.cmake.in"
        "${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake"
        IMMEDIATE @ONLY)

    add_custom_target(uninstall
        COMMAND ${CMAKE_COMMAND} -P ${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake)
endif()
